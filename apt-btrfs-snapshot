#!/usr/bin/python
# Copyright (C) 2011 Canonical
#
# Author:
#  Michael Vogt
#
# This program is free software; you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation; version 3.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# this program; if not, write to the Free Software Foundation, Inc.,
# 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA

import argparse
import datetime
import logging
import os
import string
import subprocess
import sys
import tempfile

from gettext import gettext as _

from apt_btrfs_snapshot import AptBtrfsSnapshot

if __name__ == "__main__":

    # command line parser
    description = _("Filesystem snapshot support for apt")
    parser = argparse.ArgumentParser(description=description)
    parser.add_argument("--debug", action="store_true", default=False,
                        help="enable debug output")

    subparser = parser.add_subparsers(title="Commands")
    # supported
    command = subparser.add_parser("supported")
    command.set_defaults(command="supported")
    # snapshot 
    command = subparser.add_parser("snapshot")
    command.set_defaults(command="snapshot")
    # list
    command = subparser.add_parser("list")
    command.set_defaults(command="list")
    # set-default
    command = subparser.add_parser("set-default")
    command.add_argument("snapshot")
    command.set_defaults(command="set-default")
    # delete
    command = subparser.add_parser("delete")
    command.add_argument("snapshot")
    command.set_defaults(command="delete")
    # list-older-than
    command = subparser.add_parser("list-older-than")
    command.add_argument("time")
    command.set_defaults(command="list-older-than")
    # delete-older-than
    command = subparser.add_parser("delete-older-than")
    command.add_argument("time")
    command.set_defaults(command="delete-older-than")

    # parse args
    args = parser.parse_args()

    # global options
    if args.debug:
        logging.basicConfig(level=logging.DEBUG)
    else:
        logging.basicConfig(level=logging.INFO)

    if os.getuid() != 0:
        print "Sorry, you need to be root to run this program"
        sys.exit(1)

    apt_btrfs = AptBtrfsSnapshot()
    if not apt_btrfs.snapshots_supported():
        print "Sorry, your system lacks support for the snapshot feature"
        sys.exit(1)

    res = False
    if args.command == "supported":
        res = apt_btrfs.snapshots_supported()
    elif args.command == "snapshot":
        res = apt_btrfs.create_btrfs_root_snapshot()
    elif args.command == "list":
        res = apt_btrfs.print_btrfs_root_snapshots()
    elif args.command == "set-default":
        res = apt_btrfs.command_set_default(args.snapshot)
    elif args.command == "delete":
        res = apt_btrfs.delete_snapshot(args.snapshot)
    elif args.command == "list-older-than":
        res = apt_btrfs.print_btrfs_root_snapshots_older_than(args.time)
    elif args.command == "delete-older-than":
        res = apt_btrfs.clean_btrfs_root_snapshots_older_than(args.time)
    else:
        print "ERROR: Unhandled command: '%s'" % args.command

    if res:
        sys.exit(0)
    else:
        sys.exit(1)




